<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å“¡å·¥å¤§æˆ°è€é—†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            overflow: hidden;
            background: #2c3e50;
            touch-action: none;
        }
        #gameCanvas {
            display: block;
            width: 100%;
            height: 100vh;
        }
        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0,0,0,0.8);
            color: white;
            z-index: 10;
        }
        .hidden {
            display: none;
        }
        h1 {
            font-size: 48px;
            margin-bottom: 20px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
        }
        button {
            padding: 15px 40px;
            font-size: 24px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px;
            transition: all 0.3s;
        }
        button:active {
            transform: scale(0.95);
        }
        .touch-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 200px;
            pointer-events: none;
            z-index: 5;
        }
        .touch-btn {
            position: absolute;
            background: rgba(52, 152, 219, 0.6);
            border: 3px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
            pointer-events: auto;
            user-select: none;
        }
        .touch-btn:active {
            background: rgba(41, 128, 185, 0.9);
            transform: scale(0.95);
        }
        .touch-btn.left {
            left: 20px;
            bottom: 80px;
            width: 70px;
            height: 70px;
        }
        .touch-btn.right {
            left: 110px;
            bottom: 80px;
            width: 70px;
            height: 70px;
        }
        .touch-btn.jump {
            left: 65px;
            bottom: 160px;
            width: 60px;
            height: 60px;
            background: rgba(46, 204, 113, 0.6);
        }
        .touch-btn.attack {
            right: 110px;
            bottom: 80px;
            width: 75px;
            height: 75px;
            background: rgba(231, 76, 60, 0.6);
        }
        .touch-btn.ultimate {
            right: 20px;
            bottom: 80px;
            width: 75px;
            height: 75px;
            background: rgba(155, 89, 182, 0.6);
        }
        .touch-btn.ultimate.disabled {
            background: rgba(127, 140, 141, 0.4);
        }
        .touch-btn.charge {
            right: 20px;
            bottom: 170px;
            width: 60px;
            height: 60px;
            background: rgba(241, 196, 15, 0.6);
        }
        .touch-btn.charge:active {
            background: rgba(243, 156, 18, 0.9);
        }
    </style>
</head>
<body>
    <div id="startScreen" class="screen">
        <h1>ğŸ‘”å“¡å·¥å¤§æˆ°è€é—†</h1>
        <p style="font-size: 20px; margin-bottom: 30px;">è¾¦å…¬å®¤å¾©ä»‡æ™‚åˆ»ï¼</p>
        <button onclick="startGame()">é–‹å§‹æˆ°é¬¥</button>
    </div>
    <div id="winScreen" class="screen hidden">
        <h1>ğŸ‰ å‹åˆ©ï¼ğŸ‰</h1>
        <p style="font-size: 24px; margin-bottom: 30px;">ä½ æˆåŠŸæ“Šæ•—äº†å£“æ¦¨ä½ çš„è€é—†ï¼</p>
        <button onclick="restartGame()">å†æˆ°ä¸€æ¬¡</button>
    </div>
    <div id="loseScreen" class="screen hidden">
        <h1>ğŸ˜¢ å¤±æ•—...</h1>
        <p style="font-size: 24px; margin-bottom: 30px;">è€é—†çš„å£“åŠ›å¤ªå¤§äº†...</p>
        <button onclick="restartGame()">æ²åœŸé‡ä¾†</button>
    </div>
    <canvas id="gameCanvas"></canvas>
    <div class="touch-controls">
        <div class="touch-btn left" id="btnLeft">â—„</div>
        <div class="touch-btn right" id="btnRight">â–º</div>
        <div class="touch-btn jump" id="btnJump">â–²</div>
        <div class="touch-btn attack" id="btnAttack">æ‹³</div>
        <div class="touch-btn charge" id="btnCharge">âš¡</div>
        <div class="touch-btn ultimate" id="btnUltimate">çµ•</div>
    </div>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let gameRunning = false;
        let keys = {};
        let touchState = {left: false, right: false, jump: false, attack: false, ultimate: false, charge: false};
        const game = {gravity: 0.8, groundY: 0};
        let player, boss, particles = [];

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            game.groundY = canvas.height - 100;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        class Fighter {
            constructor(x, isPlayer) {
                this.x = x;
                this.y = game.groundY;
                this.width = 50;
                this.height = 80;
                this.velocityY = 0;
                this.velocityX = 0;
                this.isJumping = false;
                this.health = 100;
                this.maxHealth = 100;
                this.mana = 0;
                this.maxMana = 100;
                this.isPlayer = isPlayer;
                this.attackCooldown = 0;
                this.isAttacking = false;
                this.ultimateCooldown = 0;
                this.hitCooldown = 0;
                this.isCharging = false;
                this.comboCount = 0;
                this.lastAttackTime = 0;
            }
            update() {
                this.velocityY += game.gravity;
                this.y += this.velocityY;
                if (this.y >= game.groundY) {
                    this.y = game.groundY;
                    this.velocityY = 0;
                    this.isJumping = false;
                }
                this.x += this.velocityX;
                this.velocityX *= 0.9;
                if (this.x < 50) this.x = 50;
                if (this.x > canvas.width - 100) this.x = canvas.width - 100;
                if (this.attackCooldown > 0) this.attackCooldown--;
                if (this.ultimateCooldown > 0) this.ultimateCooldown--;
                if (this.hitCooldown > 0) this.hitCooldown--;
            }
            move(direction) {
                this.velocityX = direction * 5;
            }
            jump() {
                if (!this.isJumping && this.y >= game.groundY) {
                    this.velocityY = -15;
                    this.isJumping = true;
                }
            }
            attack() {
                if (this.attackCooldown === 0) {
                    this.isAttacking = true;
                    this.attackCooldown = 30;
                    setTimeout(() => this.isAttacking = false, 200);
                    return true;
                }
                return false;
            }
            ultimate() {
                if (this.mana >= this.maxMana && this.ultimateCooldown === 0) {
                    this.mana = 0;
                    this.ultimateCooldown = 60;
                    return true;
                }
                return false;
            }
            takeDamage(damage) {
                if (this.hitCooldown === 0) {
                    this.health -= damage;
                    this.hitCooldown = 20;
                    if (this.health < 0) this.health = 0;
                }
            }
            gainMana(amount) {
                this.mana += amount;
                if (this.mana > this.maxMana) this.mana = this.maxMana;
            }
            charge() {
                this.isCharging = true;
            }
            stopCharge() {
                this.isCharging = false;
            }
            getAttackRange() {
                return this.isPlayer ? 80 : 70;
            }
            draw() {
                if (this.hitCooldown > 0 && this.hitCooldown % 4 < 2) {
                    ctx.globalAlpha = 0.5;
                }
                
                // é›†æ°£ç‰¹æ•ˆ
                if (this.isCharging) {
                    ctx.fillStyle = 'rgba(241, 196, 15, 0.3)';
                    ctx.beginPath();
                    ctx.arc(this.x + 25, this.y + 40, 40 + Math.sin(Date.now() / 100) * 5, 0, Math.PI * 2);
                    ctx.fill();
                }

                if (this.isPlayer) {
                    ctx.fillStyle = '#fdbcb4';
                    ctx.fillRect(this.x + 15, this.y + 10, 20, 20);
                    ctx.fillStyle = '#000';
                    ctx.fillRect(this.x + 18, this.y + 15, 3, 3);
                    ctx.fillRect(this.x + 27, this.y + 15, 3, 3);
                    ctx.fillRect(this.x + 20, this.y + 23, 8, 2);
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(this.x + 10, this.y + 30, 30, 30);
                    ctx.fillStyle = '#3498db';
                    ctx.fillRect(this.x + 23, this.y + 30, 4, 20);
                    ctx.fillStyle = '#2c3e50';
                    ctx.fillRect(this.x + 10, this.y + 60, 30, 20);
                    ctx.fillStyle = '#fdbcb4';
                    ctx.fillRect(this.x + 5, this.y + 35, 5, 15);
                    ctx.fillRect(this.x + 40, this.y + 35, 5, 15);
                    if (this.isAttacking) {
                        ctx.fillStyle = '#ecf0f1';
                        ctx.fillRect(this.x + 45, this.y + 30, 20, 15);
                        ctx.strokeStyle = '#000';
                        ctx.lineWidth = 1;
                        ctx.strokeRect(this.x + 45, this.y + 30, 20, 15);
                        // æ”»æ“Šç¯„åœæŒ‡ç¤º
                        ctx.strokeStyle = 'rgba(52, 152, 219, 0.5)';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(this.x + 50, this.y + 20, this.getAttackRange(), 60);
                    }
                } else {
                    ctx.fillStyle = '#fdbcb4';
                    ctx.fillRect(this.x + 15, this.y + 5, 20, 25);
                    ctx.fillStyle = '#000';
                    ctx.fillRect(this.x + 18, this.y + 12, 4, 4);
                    ctx.fillRect(this.x + 26, this.y + 12, 4, 4);
                    ctx.fillRect(this.x + 17, this.y + 10, 5, 2);
                    ctx.fillRect(this.x + 26, this.y + 10, 5, 2);
                    ctx.fillRect(this.x + 20, this.y + 23, 10, 3);
                    ctx.fillStyle = '#2c3e50';
                    ctx.fillRect(this.x + 10, this.y + 30, 30, 35);
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(this.x + 20, this.y + 32, 10, 10);
                    ctx.fillStyle = '#34495e';
                    ctx.fillRect(this.x + 10, this.y + 65, 30, 15);
                    ctx.fillStyle = '#fdbcb4';
                    ctx.fillRect(this.x + 5, this.y + 35, 5, 15);
                    ctx.fillRect(this.x + 40, this.y + 35, 5, 15);
                    if (this.isAttacking) {
                        ctx.fillStyle = '#e74c3c';
                        ctx.beginPath();
                        ctx.arc(this.x - 10, this.y + 40, 10, 0, Math.PI * 2);
                        ctx.fill();
                        // æ”»æ“Šç¯„åœæŒ‡ç¤º
                        ctx.strokeStyle = 'rgba(231, 76, 60, 0.5)';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(this.x - this.getAttackRange() - 50, this.y + 20, this.getAttackRange(), 60);
                    }
                }
                ctx.globalAlpha = 1;
            }
        }

        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 5;
                this.vy = (Math.random() - 0.5) * 5 - 2;
                this.life = 30;
                this.color = color;
                this.size = Math.random() * 4 + 2;
            }
            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += 0.2;
                this.life--;
            }
            draw() {
                ctx.fillStyle = this.color;
                ctx.globalAlpha = this.life / 30;
                ctx.fillRect(this.x, this.y, this.size, this.size);
                ctx.globalAlpha = 1;
            }
        }

        function drawBackground() {
            const s = Math.min(canvas.width / 1000, canvas.height / 600);
            ctx.fillStyle = '#7f8c8d';
            ctx.fillRect(0, game.groundY + 80, canvas.width, canvas.height);
            ctx.fillStyle = '#ecf0f1';
            ctx.fillRect(0, 0, canvas.width, game.groundY + 80);
            for (let i = 0; i < 3; i++) {
                const x = (50 + i * 200) * s;
                const y = 40 * s;
                const w = 120 * s;
                const h = 160 * s;
                ctx.fillStyle = '#87ceeb';
                ctx.fillRect(x, y, w, h);
                ctx.fillStyle = 'rgba(255,255,255,0.7)';
                ctx.beginPath();
                ctx.arc(x + 30*s, y + 50*s, 20*s, 0, Math.PI*2);
                ctx.arc(x + 50*s, y + 50*s, 25*s, 0, Math.PI*2);
                ctx.arc(x + 70*s, y + 50*s, 20*s, 0, Math.PI*2);
                ctx.fill();
                ctx.strokeStyle = '#34495e';
                ctx.lineWidth = 4*s;
                ctx.strokeRect(x, y, w, h);
                ctx.beginPath();
                ctx.moveTo(x+w/2, y);
                ctx.lineTo(x+w/2, y+h);
                ctx.moveTo(x, y+h/2);
                ctx.lineTo(x+w, y+h/2);
                ctx.stroke();
            }
            const dx = canvas.width * 0.65;
            const dy = game.groundY - 30;
            ctx.fillStyle = '#a0522d';
            ctx.fillRect(dx, dy, 120*s, 15*s);
            ctx.fillRect(dx+10*s, dy+15*s, 10*s, 50*s);
            ctx.fillRect(dx+100*s, dy+15*s, 10*s, 50*s);
            ctx.fillStyle = '#2c3e50';
            ctx.fillRect(dx+35*s, dy-30*s, 50*s, 30*s);
            ctx.fillStyle = '#27ae60';
            ctx.fillRect(dx+40*s, dy-27*s, 40*s, 22*s);
            ctx.fillStyle = '#fff';
            ctx.font = `${10*s}px monospace`;
            ctx.fillText('OT', dx+48*s, dy-12*s);
            const px = canvas.width * 0.15;
            const py = game.groundY - 20;
            ctx.fillStyle = '#c0392b';
            ctx.fillRect(px, py, 30*s, 25*s);
            ctx.fillStyle = '#27ae60';
            ctx.beginPath();
            ctx.arc(px+15*s, py-15*s, 20*s, 0, Math.PI*2);
            ctx.fill();
        }

        function drawUI() {
            const w = Math.min(300, canvas.width * 0.35);
            const m = 20;
            ctx.fillStyle = 'rgba(0,0,0,0.5)';
            ctx.fillRect(m, m, w+4, 34);
            ctx.fillStyle = '#e74c3c';
            ctx.fillRect(m+2, m+2, w, 15);
            ctx.fillStyle = '#27ae60';
            ctx.fillRect(m+2, m+2, (player.health/100)*w, 15);
            ctx.fillStyle = '#fff';
            ctx.font = '14px Arial';
            ctx.fillText('å“¡å·¥', m+2, m+30);
            ctx.fillStyle = '#34495e';
            ctx.fillRect(m+2, m+20, w, 10);
            ctx.fillStyle = '#3498db';
            ctx.fillRect(m+2, m+20, (player.mana/100)*w, 10);
            ctx.fillStyle = 'rgba(0,0,0,0.5)';
            ctx.fillRect(canvas.width-w-m-4, m, w+4, 34);
            ctx.fillStyle = '#e74c3c';
            ctx.fillRect(canvas.width-w-m-2, m+2, w, 15);
            ctx.fillStyle = '#27ae60';
            ctx.fillRect(canvas.width-w-m-2, m+2, (boss.health/100)*w, 15);
            ctx.textAlign = 'right';
            ctx.fillText('è€é—†', canvas.width-m-2, m+30);
            ctx.textAlign = 'left';
            ctx.fillStyle = '#34495e';
            ctx.fillRect(canvas.width-w-m-2, m+20, w, 10);
            ctx.fillStyle = '#9b59b6';
            ctx.fillRect(canvas.width-w-m-2, m+20, (boss.mana/100)*w, 10);
        }

        function checkCollision(f1, f2) {
            const range = f1.getAttackRange();
            const attackBox = {
                x: f1.isPlayer ? f1.x + 50 : f1.x - range - 50,
                y: f1.y + 20,
                width: range,
                height: 60
            };
            return attackBox.x < f2.x + f2.width &&
                   attackBox.x + attackBox.width > f2.x &&
                   attackBox.y < f2.y + f2.height &&
                   attackBox.y + attackBox.height > f2.y;
        }

        function bossAI() {
            const d = Math.abs(boss.x - player.x);
            
            // æ›´æ™ºèƒ½çš„ç§»å‹•
            if (d > 180) {
                boss.move(player.x > boss.x ? 1 : -1);
            } else if (d < 60) {
                boss.move(player.x > boss.x ? -1 : 1);
            } else if (d > 100 && d < 150) {
                // ä¿æŒä¸­ç­‰è·é›¢
                if (Math.random() < 0.5) {
                    boss.move(player.x > boss.x ? 1 : -1);
                }
            }
            
            // æ›´é »ç¹çš„è·³èº
            if (Math.random() < 0.03 && !boss.isJumping) boss.jump();
            
            // é€£çºŒæ”»æ“Š
            if (Math.random() < 0.04 && d < 120) {
                if (boss.attack() && checkCollision(boss, player)) {
                    const damage = 8 + boss.comboCount * 2;
                    player.takeDamage(damage);
                    boss.gainMana(10);
                    boss.comboCount++;
                    boss.lastAttackTime = Date.now();
                    for (let i = 0; i < 8; i++) particles.push(new Particle(player.x+25, player.y+40, '#e74c3c'));
                }
            }
            
            // é‡ç½®é€£æ“Š
            if (Date.now() - boss.lastAttackTime > 2000) {
                boss.comboCount = 0;
            }
            
            // é›†æ°£
            if (Math.random() < 0.015 && boss.mana < 80 && d > 150) {
                boss.charge();
                boss.gainMana(3);
            } else if (Math.random() < 0.02) {
                boss.stopCharge();
            }
            
            // å¤§çµ•æ‹›
            if (Math.random() < 0.02 && boss.mana >= 100) {
                if (boss.ultimate() && d < 250) {
                    const damage = 35;
                    player.takeDamage(damage);
                    // éœ‡å‹•æ•ˆæœ
                    for (let i = 0; i < 50; i++) {
                        particles.push(new Particle(
                            player.x + 25 + (Math.random() - 0.5) * 100,
                            player.y + 40 + (Math.random() - 0.5) * 100,
                            '#9b59b6'
                        ));
                    }
                    // é–ƒé›»æ•ˆæœ
                    for (let i = 0; i < 30; i++) {
                        particles.push(new Particle(
                            boss.x + 25 + (Math.random() - 0.5) * 200,
                            boss.y + (Math.random() - 0.5) * 150,
                            '#f39c12'
                        ));
                    }
                }
            }
        }

        function gameLoop() {
            if (!gameRunning) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawBackground();
            if (keys['a'] || keys['A'] || touchState.left) player.move(-1);
            if (keys['d'] || keys['D'] || touchState.right) player.move(1);
            if (keys['w'] || keys['W'] || touchState.jump) {
                player.jump();
                keys['w'] = keys['W'] = false;
                touchState.jump = false;
            }
            if (keys['j'] || keys['J'] || touchState.attack) {
                if (player.attack() && checkCollision(player, boss)) {
                    const damage = 10 + player.comboCount * 3;
                    boss.takeDamage(damage);
                    player.gainMana(12);
                    player.comboCount++;
                    player.lastAttackTime = Date.now();
                    for (let i = 0; i < 8; i++) particles.push(new Particle(boss.x+25, boss.y+40, '#3498db'));
                }
                keys['j'] = keys['J'] = false;
                touchState.attack = false;
            }
            
            // é›†æ°£
            if (keys['l'] || keys['L'] || touchState.charge) {
                player.charge();
                player.gainMana(2);
            } else {
                player.stopCharge();
            }
            
            // é‡ç½®é€£æ“Š
            if (Date.now() - player.lastAttackTime > 2000) {
                player.comboCount = 0;
            }
            
            if (keys['k'] || keys['K'] || touchState.ultimate) {
                if (player.ultimate()) {
                    boss.takeDamage(35);
                    // å¼·åŒ–å¿…æ®ºæŠ€æ•ˆæœ
                    for (let i = 0; i < 50; i++) {
                        particles.push(new Particle(
                            boss.x + 25 + (Math.random() - 0.5) * 100,
                            boss.y + 40 + (Math.random() - 0.5) * 100,
                            '#f39c12'
                        ));
                    }
                    // è¡æ“Šæ³¢
                    for (let i = 0; i < 30; i++) {
                        particles.push(new Particle(
                            player.x + 25 + (Math.random() - 0.5) * 200,
                            player.y + (Math.random() - 0.5) * 150,
                            '#e74c3c'
                        ));
                    }
                }
                keys['k'] = keys['K'] = false;
                touchState.ultimate = false;
            }
            const ub = document.getElementById('btnUltimate');
            if (player.mana >= 100) ub.classList.remove('disabled');
            else ub.classList.add('disabled');
            bossAI();
            player.update();
            boss.update();
            particles = particles.filter(p => p.life > 0);
            particles.forEach(p => {p.update(); p.draw();});
            player.draw();
            boss.draw();
            drawUI();
            if (player.health <= 0) endGame(false);
            else if (boss.health <= 0) endGame(true);
            requestAnimationFrame(gameLoop);
        }

        function startGame() {
            document.getElementById('startScreen').classList.add('hidden');
            player = new Fighter(100, true);
            boss = new Fighter(canvas.width - 150, false);
            particles = [];
            gameRunning = true;
            gameLoop();
        }

        function endGame(win) {
            gameRunning = false;
            if (win) document.getElementById('winScreen').classList.remove('hidden');
            else document.getElementById('loseScreen').classList.remove('hidden');
        }

        function restartGame() {
            document.getElementById('winScreen').classList.add('hidden');
            document.getElementById('loseScreen').classList.add('hidden');
            startGame();
        }

        window.addEventListener('keydown', e => keys[e.key] = true);
        window.addEventListener('keyup', e => keys[e.key] = false);

        function setupTouch(id, key) {
            const btn = document.getElementById(id);
            btn.addEventListener('touchstart', e => {e.preventDefault(); touchState[key] = true;});
            btn.addEventListener('touchend', e => {e.preventDefault(); touchState[key] = false;});
            btn.addEventListener('touchcancel', e => {e.preventDefault(); touchState[key] = false;});
        }
        setupTouch('btnLeft', 'left');
        setupTouch('btnRight', 'right');
        setupTouch('btnJump', 'jump');
        setupTouch('btnAttack', 'attack');
        setupTouch('btnCharge', 'charge');
        setupTouch('btnUltimate', 'ultimate');
    </script>
</body>
</html>